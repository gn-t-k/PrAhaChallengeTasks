# トランザクションについて理解する

## トランザクションとは

トランザクションとは、複数の処理を「結果の整合性が求められる一連の作業」としてまとめたもの。トランザクション内のすべての処理が成功した場合、処理の内容が反映され（**コミット**）、処理のうち一つでも成功しなかった場合、トランザクション実行前の状態に戻す（**ロールバック**）ことを保証する。

## トランザクションシステムが持つべき性質

トランザクションシステムの信頼性は、ACID特性と呼ばれる4つの性質で定義されている。

### 不可分性（Atomicity）

トランザクションは完全に実行されるか、全く実行されないかのどちらかであるという性質。処理が部分的に完了しているという状態は存在せず、完了状態は処理済みか未処理のどちらかになる。

### 一貫性（Consistency）

トランザクションの実行前後で、データベースの整合性は保たれるという性質。実行結果は矛盾した状態にはならず、同一の処理は何度実行しても同じ結果を返す。

### 独立性（Isolation）

トランザクションは独立しており、トランザクション内で行われる操作は他のトランザクションに影響を与えないという性質。トランザクションを複数同時に実行しても、単独で実行した場合と同じ処理結果になる。

### 永続性（Durability）

トランザクションが完了した時点でその結果は永続的となり、結果は失われないという性質。すべての操作はログとして保存され、以上が発生した場合でもログをもとに結果を復元することができる。

## 独立性について

### トランザクションの独立性を保つために防ぐべき現象

同時に実行される複数のトランザクションにおいて、トランザクションの独立性を保つために防ぐべき3つの現象がANSI/ISOのSQL規格に定義されている。

#### ダーティリード

トランザクション内で読み込もうとしたデータが、他のトランザクションによる処理が実行されている最中である場合でも、そのデータを読みとれてしまう現象。他のトランザクションによる処理の結果ロールバックが発生し、読み取り時と異なる値のデータになってしまう可能性がある。

#### ファジーリード

トランザクション内で複数回データを読み込むとき、そのトランザクションの処理の途中に別のトランザクションによって対象のデータが更新されてしまい、データに一貫性がなくなってしまう現象。読み込んだタイミングによって異なる値のデータになってしまう可能性がある。

#### ファントムリード

トランザクション内で条件を指定して行の集合を読み込んだあと、他のトランザクションによってその条件を満たす行が追加もしくは削除された場合、再度読み込み時に最初の読み込み時と異なる数のデータが読み込まれてしまう現象。

### トランザクション分離レベル

トランザクションの独立性を保てなくなる可能性がある現象を避けるために、複数のトランザクションの処理をする場合は、トランザクションを1つずつ逐次的に実行するという手法が考えられる。しかし、複数のトランザクションを逐次的に処理した場合、すべてのトランザクションの実行が完了するまでにそれぞれのトランザクションに待ち時間が発生してしまい、データベースの性能が低下する。独立性の低下を許容して、複数のトランザクションを並行に処理する場合、どの程度独立性の低下を許容するのかを段階的に定義したものとして**トランザクション分離レベル**がある。

トランザクション分離レベルは、トランザクションの独立性を保つために防ぐべき3つの現象のうちどこまでを許容するかによって、4段階でANSI/ISOのSQL規格に定義されている。

| トランザクション分離レベル | ダーティリード | ファジーリード | ファントムリード |
| - | - | - | - |
| READ UNCOMMITTED | 許容する | 許容する | 許容する |
| READ COMMITTED | 許容しない | 許容する | 許容する |
| REPEATABLE READ | 許容しない | 許容しない | 許容する |
| SERIALIZABLE | 許容しない | 許容しない | 許容しない |

#### READ UNCOMMITTED

読み込もうとしたデータが、他のトランザクションによる処理が実行されている最中である場合でも、そのデータを読み取る。

#### READ COMMITTED

常にコミット済みのデータのみを読み取る。

#### REPEATABLE READ

同じトランザクション中では、同じデータは何度読み込んでも同じ値になる。

#### SERIALIZABLE

複数の並行に動作するトランザクションのそれぞれの結果は、すべてのトランザクションを逐次的に実行した場合と必ず同じになる。

### ロックについて

トランザクション分離レベルに定義されているような読み取り・書き込みの制限を実現するための機能として、データベースのロックがある。

#### 悲観的ロック

トランザクションによるデータの更新中は、他のトランザクションによって対象のデータの読み取り・書き込みをできなくする。ロックが開放されるまで他のトランザクションはデータを操作することができないので、システムの応答性が悪くなることがある。

#### 楽観的ロック

トランザクションによるデータの更新を始める直前にデータのコピーをスナップショットとして保存しておき、データの更新処理が完了するまでの間に他のトランザクションによりデータが更新されていた場合、エラーとして更新を失敗させる。更新が同時に要求されることが多いと、頻繁に失敗するようになる。

#### デッドロック

ロックをかける順番によっては、トランザクション間でお互いのロックの解放を待つ状態になってしまい、ロック化解除されなくなってしまう現象のこと。
