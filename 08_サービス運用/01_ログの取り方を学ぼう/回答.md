# ログの取り方を学ぼう

## 課題1

### ログレベルとは

サーバーに起きた事象を記録することを「ログ」と呼び、内容の重要度によってレベル分けすることをログレベルという。

例として、PSR-3（PHPの規約）では以下のように定義されている。

| ログレベル | 説明 | 例 |
| - | - | - |
| emergency | システムが使用不可能な状態 | - |
| alert | 直ちに何らかの対処の必要がある | webサイトがダウンした、データベースが使用不可、など |
| critical | 危機的な状態 |  |
| error | 直ちに対処する必要のない実行時エラーだが、通常はログに記録して監視すべき |  |
| warning | エラーではない例外的な出来事 | application componentが使用不可、予期しない例外、など |
| notice | 正常だが、重要な事象 | - |
| info | 興味深い事象 | ユーザーのログインやSQLログ |
| debug | 詳細なデバッグ情報 | - |

### アプリケーションログに含めるべき内容

- 収集・管理したい情報（↑のログレベルに該当する情報）

### アプリケーションログに含めるべきではない内容

- 収集・管理する目的がはっきりしていない情報
  - 不要なログが大量にあると、ログそのものがうるさい・信頼されないものになってしまい、必要な情報が流れてしまう
- セキュリティ的にまずい情報

### ログを出力するべきタイミング

| ログレベル | タイミング |
| - | - |
| info, debug | 処理の開始時や途中経過、処理終了時など |
| error, warning | 例外や特定のイベントが発生したタイミング |
| emergency, alert, critical | 例外や特定のイベントが発生したタイミング、バッチで定期的に動かしているe2eテストがコケた時とかもいいかもしれない |

### ログのパースについて

ログには、構造化ログと非構造化ログの2つのタイプがある。

#### 非構造化ログ

プレインテキストで出力されるログ。情報を特定の区切り文字で区切り、決まった順番で出力するなどする。

#### 構造化ログ

プレインテキストではなく、JSONなどのデータ形式で出力されたログ。非構造化ログと比べてデータ容量は増えるが、機械的に検索しやすくなる。

### ログの種類

#### アクセスログ

webサーバーやAPIサーバーへのリクエストを記録したログ。いつ誰が何をリクエストしたかなどの情報を記録する。

#### エラーログ

エラー発生時エラーの内容を記録するログ。いつ誰が何をリクエストしたときに起きたエラーなのか、warningやerrorなどのエラーの程度などの情報を記録する。

#### フロントエンドのログ

フロントエンドアプリケーションは、ユーザーの行動やロード時間の監視を行う。

##### リアルユーザー監視

Googleアナリティクスなどを利用して、実際のユーザーがどのような動きをしているのか監視すること。どのような動線で動いているのか、どこで離脱しているのか、などは改善のための情報として活用しやすい。

##### 外形監視

webサイトやwebアプリケーションにユーザーと同様の方法でネットワーク外からアクセスして、ロード時間等を計測すること。ページのロード時間をCIシステムなどから計測し続け、ロード時間が許容時間内に収まっているかなどを監視する。

#### データベースのクエリログ

データベースに対して発行されたクエリを記録する。誰がいつどのようなクエリを発行したのかを記録する。

### ログローテーションとは

ログデータの肥大化を防ぐために、ログデータが一定の容量に達した時、もしくは一定期間ごとに古いログを削除すること。
