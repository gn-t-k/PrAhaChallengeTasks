# 本番稼働中のデータベースをマイグレーションしよう

## 課題1

expand and contract patternとは、データベースのマイグレーション手法の1つ。複数のステップに分けてデータベースに変更を加えることで、ダウンタイムなく、ロールバック可能にマイグレーションを実施することができる。テーブルに新しいカラムを追加する場合、以下のような手順で行う。

### 0. 初期状態

アプリケーションコードがテーブル（旧テーブルとする）に対して読み取り/書き込みの操作を行っている。新テーブルは設計完了しているが、まだデータベースには存在しない。

### 1. 新テーブルをデータベースに作成し、旧/新両方のテーブルに書き込みを行うようアプリケーションを更新する

新しいテーブルをデータベースに作成する。アプリケーションのコードは、データが旧/新両方のテーブルに書き込まれるように変更する必要があるが、データの読み込みは古いテーブルからのみ行う。

以降の手順で旧テーブルが削除されるまで、データベースは冗長的にデータを保存することになり、消費する容量と書き込み回数は増加することを考慮する。

システムはまだ古いテーブルで動作する前提のコードになっているので、この時点では新しいカラムにはデータを格納することができない。そのため、必須カラムなどの制約も適用できない。

古いテーブルには、変更前と同様にデータが書き込まれているため、このステップではかんたんにロールバックを行うことができる。

### 2. 新しいテーブルへのデータ移行

すべてのデータを旧テーブルから新テーブルにコピーする。データサイズによっては、このステップでかなりの時間がかかるため、バックグラウンドで実行する必要があり、別のサーバーインスタンスで実行することもできる。旧テーブルからデータを読み込むだけなのでアプリケーションの操作を妨げることはないが、本番システムの性能に影響を与える可能性はある。

アプリケーションからテーブルへの書き込みがあるので、楽観的または悲観的なロックなどのエラー処理が重要。

このステップではかんたんにロールバックを行うことができるが、場合によっては新テーブルを一度すべてクリアして再びコピーをする必要がある。

ステップ1で適用できなかった制約について、このステップで不足している制約を実施することができる。そうした場合、古いテーブルと新しいテーブルを完全に一致させることはもうできなくなることに注意する。このステップからロールバックすると、新しい機能によって生成されたデータを失ってしまう可能性があるため、代替案として、このステップが正常に展開されるまで新しいテーブルにデータを投入するのを延期することができる。

### 3. 新しいテーブルを運用する

このステップでは、新旧両方のテーブルに書き込みをしながら、新しいテーブルからデータを読み取るように移行する。

ここまでのステップで、新旧両方のテーブルでデータが利用できるようになった。どちらからデータを読み出しても同じ結果になるため、このステップでもロールバックは安全に行うことができる。

データを変更する理由の多くはビジネス要件の変更によってシステムに新機能が導入されたことに起因する。このステップに新しいUIの発表が含まれる場合、このステップのロールバックはユーザーに気づかれやすい。

### 4. 古いテーブルへの書き込みを止める

システムを収縮させる最初のステップとして、古いテーブルへの書き込みを止める。これ以降、データベースへの読み込みも書き込みも新しいテーブルのみに影響する。

この手順からロールバックすることは、バックアップからデータを復元する以外にもうかんたんにはできない。つまり、ロールバックにはデータの損失が伴う。

### 5. 古いテーブルを削除する

以上の手順がすべてのサーバーに展開されると、古いテーブルへの書き込み操作はできなくなる。したがって、これで古いテーブルをデータベースから安全に削除することができる。

### Expand and Contract Patternのメリット/デメリット

#### メリット

- データ構造の互換性がない変更であっても、システムを停止させることなく展開することができる
- 古いテーブルと新しいテーブルが同時に存在する期間があるため、テストをすることができる
- ひとつずつロールバックすることが容易である（ただし一度に複数のステップをロールバックした場合、安全は保証されない）
- 大規模なデータの移行が、他のステップとは別のステップとして実行できる
- 最終的には、すべてのデータには一貫性があり、冗長性がない

#### デメリット

- ダウンタイムは発生しないが、マイグレーション作業を始めてから実際に公開されるまでに時間がかかる
- 計算機資源の問題
  - 一時的にデータを冗長化して保持するため、データベースの容量を専有する領域が増加する
  - 一時的にデータを鍼灸療法のテーブルに書き込むため、書き込み回数が増加する
  - データの移行時に、移行処理によってデータベースへの負荷が増加する
- 新旧のデータ両方を利用できる期間があり、手動による介入などによって不整合を発生させる可能性がある
- 複数のステップを踏んで作業をしないといけないため、単純に労力がかかる

## 課題2

省略させてください、、、
