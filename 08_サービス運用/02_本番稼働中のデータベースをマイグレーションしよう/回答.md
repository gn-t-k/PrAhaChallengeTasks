# 本番稼働中のデータベースをマイグレーションしよう

## 課題1

expand and contract patternとは、データベースのマイグレーション手法の1つ。複数のステップに分けてデータベースに変更を加えることで、ダウンタイムなく、ロールバック可能にマイグレーションを実施することができる。テーブルに新しいカラムを追加する場合、以下のような手順で行う。

### 0. 初期状態

アプリケーションコードがテーブル（旧テーブルとする）に対して読み取り/書き込みの操作を行っている。新テーブルは設計完了しているが、まだデータベースには存在しない。

### 1. 新テーブルをデータベースに作成し、旧/新両方のテーブルに書き込みを行うようアプリケーションを更新する

新しいテーブルをデータベースに作成する。アプリケーションのコードは、データが旧/新両方のテーブルに書き込まれるように変更する必要があるが、データの読み込みは古いテーブルからのみ行う。

以降の手順で旧テーブルが削除されるまで、データベースは冗長的にデータを保存することになり、消費する容量と書き込み回数は増加することを考慮する。

システムはまだ古いテーブルで動作する前提のコードになっているので、この時点では新しいカラムにはデータを格納することができない。そのため、必須カラムなどの制約も適用できない。

古いテーブルには、変更前と同様にデータが書き込まれているため、このステップではかんたんにロールバックを行うことができる。

### 2. 新しいテーブルへのデータ移行

すべてのデータを旧テーブルから新テーブルにコピーする。データサイズによっては、このステップでかなりの時間がかかるため、バックグラウンドで実行する必要があり、別のサーバーインスタンスで実行することもできる。旧テーブルからデータを読み込むだけなのでアプリケーションの操作を妨げることはないが、本番システムの性能に影響を与える可能性はある。

アプリケーションからテーブルへの書き込みがあるので、楽観的または悲観的なロックなどのエラー処理が重要。

このステップではかんたんにロールバックを行うことができるが、場合によっては新テーブルを一度すべてクリアして再びコピーをする必要がある。

### 3. 新しいテーブルを運用する

### 4. 古いテーブルへの書き込みを止める

### 5. 古いテーブルを削除する

## 課題2
