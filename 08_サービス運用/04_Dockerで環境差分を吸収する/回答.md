# Dockerで環境差分を吸収する

## 課題1

### Dockerとは

#### Dockerイメージ

Dockerコンテナーを構成するファイルシステムや実行するアプリケーションや設定をまとめたもので、コンテナーを作成するために利用されるテンプレートとなるもの。

#### Dockerコンテナー

Dockerイメージをもとに作成され、具現化されたファイルシステムとアプリケーションが実行されている状態。

#### ベースイメージ

`Dockerfile`でイメージをビルドする際、最初に`FROM`キーワードで指定したイメージをダウンロードしてから実行される。`FROM`で取得するイメージはDocker Hubのレジストリを参照する。

#### Dockerレジストリ

Dockerイメージをホスティングするサービスのこと。Dockerの公式イメージはDocker Hubに公開されている（パブリックレジストリ）。また、AWS ECRなどのレジストリサービスを使って、イメージのpush/pullをアプリケーションのデプロイパイプラインに組み込むこともできる（プライベートレジストリ）。

#### ビルドコンテキスト

`docker build`時に、コンテナーに含めるファイルがあるディレクトリのこと。デフォルトでは`docker build`コマンドを実行したディレクトリ。

#### マルチステージビルド

イメージのビルドを複数のステージに分けて行うこと。たとえば、ビルド用のステージでビルドを行い、ビルドしたコードだけを実行用のコンテナイメージにコピーすることで、生成されるイメージのサイズを少なくすることができる。

### Dockerfileを作成して環境構築をコード化することのメリット

- 開発者間の開発環境の差異から生まれる問題を解消できる
- インフラをコードで管理できるようになる
  - ある時点でのサーバーの状態を常に再現できるようになる
  - 構成の管理がしやすくなる
- アプリケーションとインフラをセットで構築できる
  - 開発環境と本番環境の差異が生まれにくくなる

### docker-composeが役立つ場面

- 複数のアプリケーションやミドルウェアを組み合わせてシステムを構築するとき
  - コンテナーの依存関係や実行順を制御しやすい

### .dockerignoreに含めるファイルやディレクトリ

- ビルドに不要なファイルやディレクトリ
  - 不要なファイルやディレクトリをビルドに含めてしまうと、その分ビルドに時間がかかるようになってしまう

### `RUN`コマンドについて

`apt-get`のために`RUN`コマンドを使うとき、`apt-get update`と`apt-get install [something]`は同じ`RUN`コマンドで実行したほうがよい。`apt-get update`を単独で使うと、`apt-get update`の結果がキャッシュされることによって後続の`apt-get install`は失敗する可能性がある。

Dockerイメージは、Dockerfile内に記述したコマンド単位でレイヤー構造が作られる。2行`RUN`コマンドを書いてビルド→2行目の`RUN`コマンドを編集→再度ビルドすると、1行目の`RUN`コマンド以前の結果は、ビルドに成功したレイヤーとして保存されているので、2行目の`RUN`コマンドを編集しても保存されたレイヤーの状態からの差分ビルドになる。

### `ENV`について

`ENV`コマンドを使うことで、Dockerfileをもとに生成したDockerコンテナー内で使える環境変数を指定することができる。`RUN export NAME='hoge'`とした場合、`NAME`はその`RUN`コマンドによって作成される中間イメージ内でしか使用することができないが、`ENV`で指定した環境変数は、レイヤーを横断して使用することができる。

## 課題2

対応済みのため省略。
