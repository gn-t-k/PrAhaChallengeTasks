# DDDを学ぶ（基礎）

## 課題1

### エンティティ

DDDにおける「エンティティ」は、ソフトウェアで解決する課題領域で扱う対象の概念を、値と振る舞いを持つオブジェクトとしてコードに落とし込んだもの。

例えば「ユーザー」をエンティティとして`User`クラスで表現すると、`name`や`age`といった値や`changeName`といった振る舞いを持たせることができる。

`name`や`age`は可変な値であり、`changeName`によって`name`を変更したりできる。値を変更したことによって他のオブジェクトと区別がつかなくなるとオブジェクトを適切に扱えなくなる可能性があるので、エンティティには`id`などの一意な識別子を持たせるか、組み合わせによって必ず一意になるようなプロパティを持たせるなどする。

```typescript
class User {
  private id: string;
  private name: string;
  private age: number;

  constructor(id: string, name: string, age: number) {
    this.id = id;
    this.name = name;
    this.age = age;
  }

  get name(): string {
    return this.name;
  }
  get age(): number {
    return this.age;
  }
  public changeName(name: string) {
    this.name = name;
  }
}
```

### 値オブジェクト

DDDにおける「値オブジェクト」は、ソフトウェアで解決する課題領域で扱う特定の数値や文字列を、計測・定量化・説明するためのオブジェクトとしてコードに落とし込んだもの。

値オブジェクトは値を不変のものとして扱うため、コンストラクタでプロパティを設定して以降はプロパティの値を更新しない。

例えば`User`クラスの`age`プロパティは、プリミティブな値`number`ではなく、値オブジェクトのクラス`Age`として扱うことができる。

```typescript
class Age {
  private age: number

  constructor(age: number) {
    if (age < 0) {
      // 値のバリデーションを設定できる。
      throw new Error('年齢は0歳以上が設定可能です')
    }
    this.age = age;
  }

  get value(): number {
    return this.age;
  }

  public isEqual(age: Age): boolean {
    // 他のAgeオブジェクトと値が等しいかどうかをチェックできる。
    return age.value === this.age;
  }
}

class User {
  private id: string;
  private name: string;
  private age: number;

  constructor(id: string, name: string, age: Age) {
    this.id = id;
    this.name = name;
    this.age = age.value;
  }

  get name(): string {
    return this.name;
  }
  get age(): number {
    return this.age;
  }
  public changeName(name: string): void {
    this.name = name;
  }
}
```

### 集約

DDDにおける「集約」は、オブジェクトのまとまりを表し、整合性を保ちながらデータを更新する単位である。集約に含まれるオブジェクトの生成・読み込み・変更・保存などをとりまとめる役割がある。

集約は集約ルートと呼ばれるオブジェクトを持つ。集約内のオブジェクトに対する操作は、すべて集約ルートをインターフェースとして行われる。これにより、集約内のデータが不正に操作されることを防ぐことができる。

### ユビキタス言語

ドメインエキスパートや開発者などのステークホルダー内で統一した共通言語のこと。ユビキタス言語を用意することによって、ステークホルダー間のコミュニケーションがしやすくなる。

### 境界づけられたコンテキスト

境界づけられたコンテキストとは、ユビキタス言語を適用する範囲のこと。

システムの規模が大きくなってくると、ユビキタス言語としては同じものであってもコンテキスト（文脈）によっては呼び方や扱い方が変わってくるような概念が生まれることがある。全てのシステム内で概念を統一して共通化しようした場合、その概念が巨大になりすぎてしまい、扱いづらくなることがある。DDDでは、大きなシステムを「境界づけられたコンテキスト」に分割し、それぞれのコンテキスト内でモデルやユビキタス言語の統一を目指す。

### ドメイン

DDDにおけるドメインとは、ソフトウェアで解決しようとする課題領域のこと。

DDDでは、エンティティや値オブジェクト、集約と呼ばれる概念を使って、ドメインで扱う概念をオブジェクトの形でコードに落とし込んで表現する。ドメインで扱う概念をオブジェクトで表現したものをドメインオブジェクトと呼ぶ。

### ドメインサービス

ドメインサービスとは、ドメインオブジェクトだけではドメインで扱う概念を適切に表現できない場合に定義される振る舞いのこと。

DDDでは、ドメインで扱う概念は極力ドメインオブジェクトで表現し、どうしてもそれが難しい場合のみドメインサービスで表現する。ドメインオブジェクトで表現するべき情報をドメインサービスで表現してしまうと、同一の処理があらゆる場所に書かれてしまったり、コードのドキュメント性が低下するなどの弊害が起きることがある。

### リポジトリ

DDDにおけるリポジトリとは、ドメインで取り扱う情報をデータベースなどに格納・データベースから取得するための振る舞いを定義したインターフェースのこと。

情報のデータベースへの格納・データベースからの取得は、集約の単位で行われる。

### アプリケーションサービス

DDDにおけるアプリケーションサービスとは、ソフトウェアとして利用者の問題を解決するために、ドメインオブジェクトやドメインサービスを使ってユースケースを組み立てる処理の集まりのこと。

### CQRS

CQRS(Command Query Responsibility Segregation)とは、情報の参照に使用するオブジェクトと情報の更新に使用するオブジェクトを分離するというアーキテクチャパターンのこと。

データの取得時に複数の集約にまたがってしまう場合、その処理を行うコードが複雑になったり、不要なデータまで取得してしまうことでパフォーマンスの悪化を招いてしまう、などの問題がある。特定のユースケースに特化した参照用のオブジェクトを用意することで、以上のような問題を解決するアプローチをすることができる。

### DTO

DTO（Data Transfer Object）とは、データ転送用のオブジェクトのこと。取得した複数集約のデータをまとめる役割があり、振る舞いなどは持たない。

## 課題2

### クイズ1

オブジェクトの生成に複雑な処理（ドメイン知識と関係ない開発者都合な処理）が必要な場合、ドメイン層からそのような複雑な処理を追い出すにはどうすればよいか。

<details>
  <summary>回答例</summary>
  ファクトリと呼ばれるパターンを利用する。
  参考：<https://codezine.jp/article/detail/10903>
</details>

### クイズ2

ログを保存する、キャッシュを保存するといったアプリケーション全体に関わる技術的な知識について、インターフェースと実装クラスはそれぞれどの層に書くべきか。

<details>
  <summary>回答例</summary>
  インターフェースはアプリケーションサービス層、実装クラスはインフラ層に記述すべき（だと考える）。
  ログ出力やキャッシュ保存といった操作はドメインに関係ない知識であるので、ドメイン層に定義すべきではないため。
</details>

### クイズ3

値オブジェクトやエンティティを生成するファクトリのメソッドについて、staticで定義することのメリットとデメリットはなにか。

<details>
  <summary>回答例</summary>

- **メリット** … ファクトリのためのインスタンスを生成する必要がなくなる。
- **デメリット** … テストが書きにくくなる。

</detials>
