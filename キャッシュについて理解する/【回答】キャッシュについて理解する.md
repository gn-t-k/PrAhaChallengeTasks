# キャッシュについて理解する

## 課題1

### キャッシュがなぜ必要なのか

過去に取得したリソースを再利用することで、ウェブサイト・ウェブアプリケーションのパフォーマンスを向上させるため。

### キャッシュの種類、それぞれの違い

- **プライベートキャッシュ** … ひとりのユーザーのためのキャッシュ。ブラウザーのキャッシュストアに保存される
- **共有キャッシュ** … 複数のユーザーによって利用されるキャッシュ。多くのユーザーから頻繁にアクセスされるリソースは、プロキシサーバーにキャッシュとして保存しておくことで、サーバーの負荷を低減できる

### ブラウザがキャッシュを制御するためのHTTPヘッダ

#### Cache-Controlヘッダ

##### キャッシュしない制御

HTTPヘッダに`Cache-Control: no-store`を設定することで、HTTPリクエスト・レスポンスはキャッシュに保存されなくなる。リクエストは毎回サーバーに送信され、レスポンスはリクエストごとに毎回サーバーから送信される。

##### キャッシュを返却する前に毎回再検証する

HTTPヘッダに`Cache-Control: no-cache`を設定することで、キャッシュを渡す前に毎回「キャッシュのリソースが最新か」リクエストがサーバーへ送られるようになる。

##### プライベートキャッシュか共有キャッシュかを決める

HTTPヘッダに`Cache-Control: private`を設定することで、レスポンスがユーザー一人のためのものであり、共有キャッシュに保存してはならないことを示すことができる。

一方、`Cache-Control: public`を設定することで、どのようなキャッシュでも（共有キャッシュであっても）レスポンスを保存してよいことを示すことができる。

##### 有効期限を設定する

HTTPヘッダに`Cache-Control: max-age=<seconds>`を設定することで、キャッシュの有効期限を設定できる。有効期限が切れたキャッシュは削除されたり無視されたりすることはないため、取り扱いを定義する必要がある。

##### 有効期限が切れている場合、再検証する

HTTPヘッダに`Cache-Control: must-revalidate`を設定すると、キャッシュの有効期限が切れていた場合、「キャッシュのリソースが最新か」リクエストがサーバーに送信される。

#### ETagヘッダ

`Etag`ヘッダには、リソースを特定するための識別子を設定できる。サーバーは`ETag`の値を参照することで、リソースが更新されているかどうかを判断しデータを再送するか否かを決定できる。

### ブラウザのキャッシュサイズの上限

ブラウザのストレージの最大容量は、ハードディスクの **空き容量の50%** で、これをグローバルリミットと呼ぶ。キャッシュの生成元であるドメインには、 **グローバルリミットの20%** のみストレージを使用できるという制限もあり、これをグループリミットと呼ぶ。

使用可能なストレージの領域が全て埋まったときは、最も過去に使用された生成元のデータがはじめに削除され、上限を下回るまで削除を繰り返す。これをLRUポリシーと呼ぶ。

### 動的なサイトのキャッシュではexpiresを使わないほうがいい理由

ユーザーのプロフィールのような頻繁に更新されることが想定されるデータは、キャッシュして扱うデータとしては適切ではないため。頻繁にデータが更新されると、データとキャッシュの整合性を保つのにコストがかかる。

### ブラウザのキャッシュがWEBサービスに用いられている実例

#### MDN Web Docs

![MDN Web Docs](mdn.png)

記事ページのhtmlを、24時間の有効期限付きでキャッシュしている。また、`public`が設定されているので、プライベートキャッシュではなく共有キャッシュである可能性がある。

#### Googleカレンダー

![Googleカレンダー](googleCalender.png)

なんの処理かは不明だが、JavaScriptファイルを30分間の有効期限付きでキャッシュしている。また、`stale-with-revalidate=1800`が設定されているため、30分おきに新しいレスポンスが非同期にチェックされる。

#### HackMD

![HackMD](./hackmd.png)

詳細は不明だが、ファイル名から察するに、国際化対応のためのJavaScriptファイルがキャッシュされている。

## 課題2

実装済み。下記の操作で動作確認可能。

```shell
yarn install --frozen-lockfile
yarn dev
```

<http://localhost:8081/animal_chimpanzee.png> →キャッシュなしの画像
<http://localhost:8082/animal_chimpanzee_dougu.png> →キャッシュありの画像

## 課題3

### ブラウザキャッシュを使うべきではないケース

#### 消去されるとアプリケーションが正常に機能されなくなるようなデータ

キャッシュは、以下のような原因で消失しやすいデータである。

- 有効期限が切れる
- ストレージの空き容量が足りなくなって削除される
- ユーザーによって削除される

そのため、消去されることによってアプリケーションが正常に機能されなくなるようなデータは、キャッシュすべきではない。

#### 読み込み頻度が低いデータ

読み込み頻度が高いほど、キャッシュによって節約されるトラフィックや読み込み時間は多くなるため、キャッシュから受ける恩恵は大きくなる。

#### 書き込み頻度が高いデータ

データの更新が多くなると、そのぶんキャッシュの整合性を保つためのコストがかかるため、書き込み頻度が高いデータをキャッシュするのは避けたほうがよい。

## 課題4

### クイズ1

ブラウザのストレージ使用量がキャッシュを保存できる最大容量に達したとき、最も過去に使用されたデータから順に上限を下回るまで削除されるが、削除されるデータの単位は次のうちどれか。

1. キー・バリューの組み合わせ単位
2. 使用した日付単位
3. キャッシュの生成元単位

<details>
  <summary>回答</summary>
  <b>3</b><br />
  生成元単位で消去されないと、データの整合性が取れなくなるなどの不都合が生じる。
</details>

### クイズ2

ブラウザのシークレットモード機能を使えばキャッシュが残らないとされているが、シークレットモードのキャッシュの扱い方の説明として正しいものは以下のうちどれか。

1. シークレットモードではキャッシュは一切保存されない
2. シークレットモードのウィンドウを閉じたタイミングでキャッシュは削除される
3. 閲覧することができないだけで、キャッシュは削除されず残っている（一定時間経過後自動で削除される）

<details>
  <summary>回答</summary>
  
  **2** <br />
  検証時など、ずっと同じシークレットモードのウィンドウで確認して「あれ？シークレットモードなのに修正が反映されない？」などありそうな気がするので注意が必要。
</details>

### クイズ3

デスクトップクライアントとモバイルクライアントとで提供するコンテンツを出し分ける処理をしたい場合、どのような設定をすればよいか。

<details>
  <summary>回答</summary>

  （例）HTTPヘッダ `Vary: User-Agent` を使用する

  `Vary: User-Agent`を使用すると、サーバーは、コンテンツをキャッシュから提供するかどうかを判断するためにユーザーエージェントを考慮するようになる。
</details>
